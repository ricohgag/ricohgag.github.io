+++
title = 'DDIA-Part7: 事务'
date = 2020-12-07T11:14:33+08:00
draft = true
+++

事务指的是满足 ACID 特性的一组操作，事务中的读写是一个执行整体，要么整个成功提交，要么全部失败回滚。

## 深入理解事务

#### ACID的含义

- 原子性（Atomicity）

事务被视为最小单元，事务的所有操作要么全部提交成功，要么全部回滚失败。

回滚可以用回滚日志（Undo Log）来实现，回滚日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。

- 一致性（Consistency）

一致性主要指事务对数据有特定的预期状态，任何数据更改必须满足这些状态约束。（如银行转账，转入和转出应该保持平衡）

- 隔离型（Isolation）

并发执行多个事务时相互隔离，一个事务在最终提交前对其他事务是不可见的。

- 持久性（Durability）

事务提交后，事务做出的修改会持久化到本地磁盘而不用担心数据丢失。

#### 单对象和多对象事务操作

- 单对象写入：单对象写入也同时满足原子性和隔离性。

- 多对象事务的必要性

- 处理错误与终止

## 隔离级别

#### 未提交读

事务中的修改即使没有提交，对其他事务也是可见的。

#### 提交读

一个事务只能读取已经提交的事务所做的修改，即一个事务所做的修改在提交之前对其他事务是不可见的。可以防止脏读，脏写。

#### 快照级别隔离和可重复读

保证在同一个事务中多次读取同一数据结果是一样的。可以解决不可重复读问题。

- 实现快照隔离

使用多版本并发控制（MVCC），在 MVCC 中事务的修改操作（DELETE、INSERT、UPDATE）会为数据行新增一个版本快照。

用于实现提交读和可重复读两种级别。MVCC 规定只能读取已经提交的快照。当然一个事务可以读取自身未提交的快照，这不算是脏读。

- 一致性快照的可见性原则

当事务读取数据库时，通过事务id可以决定哪些对象可见，哪些不可见。

- 索引与快照级别隔离

1. 索引直接指向对象的所有版本，过滤对当前事务不可见的版本。

2. 采用追加/写时复制技术，当需要更新时，不会修改现有页面，总是创建新的页面，让父节点指向新创建的节点。



#### 可串行化

强制事务串型执行，多个事务互不干扰，不会出现并发一致性问题。该隔离级别需要加锁实现，保证同一时间只有一个事务执行。

## 两阶段加锁

#### 实现两阶段加锁

- 一个事务对数据对象加了X锁，就可以对A读取和更新，期间其他事务不能对A加锁。

- 一个事务对数据对象加了S锁，其他事务只能对A加S锁，不能加X锁。

#### 意向锁

- 任意 IS/IX 锁之间都是兼容的，因为它们只表示想要对表加锁，而不是真正加锁；

- 这里兼容关系针对的是表级锁，而表级的 IX 锁和行级的 X 锁兼容，两个事务可以对两个数据行加 X 锁。（事务 T1 想要对数据行 R1 加 X 锁，事务 T2 想要对同一个表的数据行 R2 加 X 锁，两个事务都需要对该表加 IX 锁，但是 IX 锁是兼容的，并且 IX 锁与行级的 X 锁也是兼容的，因此两个事务都能加锁成功，对同一个表中的两个数据行做修改。）

#### 索引区间锁

索引区间锁将保护的对象扩大化，能够防止写倾斜和幻读问题。

## 可串型化的快照隔离（SSI）

#### 悲观锁和乐观锁

两阶段加锁是悲观锁，串型执行是种极端悲观的选择。事务执行期间等价于事务对整个数据库都持有互斥锁。

可串型化的快照隔离则是一种乐观并发控制。如果可能发生冲突事务会继续执行，提交时确实发生冲突会终止事务并重试。





