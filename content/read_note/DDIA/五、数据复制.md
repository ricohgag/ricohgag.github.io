+++
title = 'DDIA-Part5: 数据复制'
date = 2020-11-30T11:14:33+08:00
draft = true
+++

复制指通过网络在多台机器上保存相同数据的副本。

- 边缘存储，降低访问延迟

- 部分组件故障，系统仍然可以使用，提高可用性。

- 扩展多台机器同时提供访问，提高读的吞吐量。

### 主从复制

原理：

1. 指定某一副本为主副本（主节点），只有主节点支持写入，主节点首先将数据写入本地存储。

2. 其他副本为从副本（从节点），主节点将新数据写入本地存储后，然后将数据更改通过日志或更改流的方式发送给所有从节点，从节点严格按照主节点的写入顺序写入本地。

3. 客户端可以在主节点或从节点上执行查询，主节点可读写，从节点只读。

#### 同步复制与异步复制

同步复制：主节点会等待从节点完成写入后才返回给客户端写入成功。

异步复制：主节点写入后向从节点发送消息，不用等待从节点写入完成确认。

半同步模式：数据库实践中，开启同步复制一般只会开启一个从节点同步，其他节点则是异步模式。当同步从节点不可用或性能下降，将其他从节点中的一个提升为同步模式。

#### 配置新的从节点

1. 在某个时间点对主节点产生一个一致性快照，避免同步主节点时锁定整个数据库。

2. 将快照拷贝到新的从节点。

3. 从节点连接主节点，并从快照节点开始追赶主节点。

#### 处理失效节点

- 从节点失效：从节点恢复后，会从崩溃时的节点继续追赶主节点。

- 主节点失效：可以通过手动或自动的将从节点提升为主节点，之后的写的请求会发送给主节点。

自动切换步骤：

1. 确认主节点失效。节点间使用心跳机制来检测主节点是否失效，一段时间内（如30s）如果没有响应，则认为该节点失效。

2. 选举新的主节点。通过选举的方式来选举指定新的主节点，候选节点最好与原生节点的数据量差异最小，可以最小化数据丢失的风险。

3. 重新配置系统使新主节点生效。客户端需要将写请求更改为发送到新的主节点。如果原主节点上线，系统要保证原主节点降级为从节点并认可新的主节点。

#### 复制日志的实现

- 基于语句复制

主节点将记录所执行的每个操作请求，将操作语句作为日志发送给从节点。基于语句复制会有一些不适用场景：

1. 任何调用非确定性函数的语句，如Now()、Random()等，在不同的副本可能会产生不同的值。

2. 自增列。

3. 有副作用的语句（如触发器、存储过程、用户定义的函数等）。

- 基于预写日志（WAL）传输

1. 日志结构存储引擎，日志段在后台压缩并支持垃圾回收。

2. 对采用覆盖写磁盘的Btree结构，每次修改会预先写入日志，如系统发生崩溃，会迅速恢复到此前一致状态。

- 基于行的逻辑日志复制

1. 对于行插入，日志包含所有相关列的新值。

2. 对于行删除，日志里有唯一标识已删除的行，通常靠主键。

3. 对于行更新，唯一标识和要更新的所有列新值。

逻辑日志与存储引擎解耦，可以更容易的向后兼容。还可以更具逻辑语句构建自定义索引和缓存。

- 基于触发器的复制

### 数据滞后问题

主节点写入之后，返回成功给客户端，客户端同时查询主节点和从节点得出不一致的数据，等一段时间后从节点同步完成，主从节点最终数据一致，这叫做**最终一致性**。

#### 读自己写

数据还没同步到子节点就查询的问题。

- 访问可能随时会被修改的内容从主节点读。

- 跟踪最近的修改时间，如果不超过一分钟则读主节点。

- 客户端记住最近的更新时间戳，当时间戳不够新访问从节点。

- 如果副本在多数据中心，必须把请求路由到主节点所在的数据中心。

#### 单调读

解决先请求后返回，后返回的数据是旧值的问题。可以确保每个用户从固定的一个副本执行读取。（如基于用户id哈希的方式）

#### 前缀一致读

当两个语句有先后关系，自节点先同步了后置关系的数据。

对于一系列按照某个顺序发生的写请求，读取内容时也会按照顺序读。

### 多主节点复制

#### 适用场景

- **多数据中心**

1. 性能

2. 容忍数据中心失效

3. 容忍网络问题

- **离线客户端操作**：协作编辑。

#### 处理写冲突

- 同步与异步冲突检测

- 避免冲突

- 收敛于一致状态

- 自定义冲突解决逻辑

1. 给每个写入分配一个唯一id（如时间戳），取最后一个写入的数据，会造成数据丢失。

2. 为每个副本分配一个唯一id，序号高的副本优先写入，也会导致数据丢失。

3. 以某种方式将值合并。

4. 利用预定义好的格式来记录和保留冲突相关的所有信息，依靠应用层逻辑解决。

#### 自定义冲突解决逻辑

解决冲突最合适的方式还是在应用层，所以大多数多主节点复制模型都有工具让用户编写应用代码解决冲突。可以在**写入时**或**读取时**执行这些代码逻辑。 

#### 拓扑结构

复制的拓扑结构描述了写请求从一个节点传播到其他节点的通信路径。最常见的是全部-至-全部每个主节点写入同步到其他主节点。

### 无主节点复制

#### 节点失效时写入数据库

r+w>n，被认为写入成功。

- 读修复与反熵

1. 读修复：当客户端并行读取多个副本，可以检测到过期的值。

2. 反熵过程：一些后台进程不断查找副本之间数据的差异并修复。

- 读写quorum：如果w + r > n 则并发r个读请求一定含有最新值（通过版本号确认）

#### Quorum一致性的局限性

- 监控旧值

- 宽松的quorum与数据回传

- 多数据中心操作

#### 检测并发写

- 最后写入者获胜

- Happens-before关系和并发

- 合并同时写入的值

- 版本矢量

