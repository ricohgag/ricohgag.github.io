<!doctype html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: light)"><meta name=generator content="Hugo 0.123.6"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="DDIA-Part5: 数据复制"><meta itemprop=description content="既然生于丛林，那就适应荆棘，enjoy，enjoy eveything, enjoy it."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/head.jpg"><meta itemprop=keywords content="intp, enjoy, push."><meta property="og:type" content="article"><meta property="og:title" content="DDIA-Part5: 数据复制"><meta property="og:description" content="既然生于丛林，那就适应荆棘，enjoy，enjoy eveything, enjoy it."><meta property="og:image" content="/imgs/head.jpg"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/read_note/ddia/%E4%BA%94%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/"><meta property="og:site_name" content="ricohgag's blog"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="ricohgag"><meta property="article:published_time" content="2020-11-30 11:14:33 +0800 +0800"><meta property="article:modified_time" content="2020-11-30 11:14:33 +0800 +0800"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.13ee0ec29320772afa2bcd02dcc418cd6b99c20af99cd4ae166a9e26fbe018aa.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"%E4%BA%94%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6","permalink":"/read_note/ddia/%E4%BA%94%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/","title":"DDIA-Part5: 数据复制","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>DDIA-Part5: 数据复制 - ricohgag's blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>ricohgag's blog</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description></p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-read_note"><a href=/read_note/ class=hvr-icon-pulse rel=section><i class="fa fa-book-open-reader hvr-icon"></i>读书笔记</a></li><li class="menu-item menu-item-book_list"><a href=/book_list/ class=hvr-icon-pulse rel=section><i class="fa fa-book hvr-icon"></i>书单</a></li><li class="menu-item menu-item-about"><a href=/about/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#主从复制>主从复制</a><ul><li><a href=#同步复制与异步复制>同步复制与异步复制</a></li><li><a href=#配置新的从节点>配置新的从节点</a></li><li><a href=#处理失效节点>处理失效节点</a></li><li><a href=#复制日志的实现>复制日志的实现</a></li></ul></li><li><a href=#数据滞后问题>数据滞后问题</a><ul><li><a href=#读自己写>读自己写</a></li><li><a href=#单调读>单调读</a></li><li><a href=#前缀一致读>前缀一致读</a></li></ul></li><li><a href=#多主节点复制>多主节点复制</a><ul><li><a href=#适用场景>适用场景</a></li><li><a href=#处理写冲突>处理写冲突</a></li><li><a href=#自定义冲突解决逻辑>自定义冲突解决逻辑</a></li><li><a href=#拓扑结构>拓扑结构</a></li></ul></li><li><a href=#无主节点复制>无主节点复制</a><ul><li><a href=#节点失效时写入数据库>节点失效时写入数据库</a></li><li><a href=#quorum一致性的局限性>Quorum一致性的局限性</a></li><li><a href=#检测并发写>检测并发写</a></li></ul></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=ricohgag src=/imgs/img-lazy-loading.gif data-src=/imgs/head.jpg><p class=site-author-name itemprop=name>ricohgag</p><div class=site-description itemprop=description>既然生于丛林，那就适应荆棘，enjoy，enjoy eveything, enjoy it.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>1</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>0</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/ricohgag title="Github → https://github.com/ricohgag" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2024-02-29T16:49:02+08:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=6></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=1></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2024-02-29T16:49:02+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/ricohgag rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"ricohgag/ricohgag.github.io"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/read_note/ddia/%E4%BA%94%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/head.jpg"><meta itemprop=name content="ricohgag"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="ricohgag"><meta itemprop=description content="既然生于丛林，那就适应荆棘，enjoy，enjoy eveything, enjoy it."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="DDIA-Part5: 数据复制"><meta itemprop=description content="复制指通过网络在多台机器上保存相同数据的副本。 边缘存储，降低访问延迟 部分组件故障，系统仍然可以使用，提高可用性。 扩展多台机器同时提供访问，提"></span><header class=post-header><h1 class=post-title itemprop="name headline">DDIA-Part5: 数据复制
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/read_note/DDIA/%e4%ba%94%e3%80%81%e6%95%b0%e6%8d%ae%e5%a4%8d%e5%88%b6.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2020-11-30 11:14:33 +0800 +0800" itemprop="dateCreated datePublished" datetime="2020-11-30 11:14:33 +0800 +0800">2020-11-30</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>1957</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>4分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/read_note/ddia/%E4%BA%94%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p>复制指通过网络在多台机器上保存相同数据的副本。</p><ul><li><p>边缘存储，降低访问延迟</p></li><li><p>部分组件故障，系统仍然可以使用，提高可用性。</p></li><li><p>扩展多台机器同时提供访问，提高读的吞吐量。</p></li></ul><h3 id=主从复制>主从复制
<a class=header-anchor href=#%e4%b8%bb%e4%bb%8e%e5%a4%8d%e5%88%b6></a></h3><p>原理：</p><ol><li><p>指定某一副本为主副本（主节点），只有主节点支持写入，主节点首先将数据写入本地存储。</p></li><li><p>其他副本为从副本（从节点），主节点将新数据写入本地存储后，然后将数据更改通过日志或更改流的方式发送给所有从节点，从节点严格按照主节点的写入顺序写入本地。</p></li><li><p>客户端可以在主节点或从节点上执行查询，主节点可读写，从节点只读。</p></li></ol><h4 id=同步复制与异步复制>同步复制与异步复制
<a class=header-anchor href=#%e5%90%8c%e6%ad%a5%e5%a4%8d%e5%88%b6%e4%b8%8e%e5%bc%82%e6%ad%a5%e5%a4%8d%e5%88%b6></a></h4><p>同步复制：主节点会等待从节点完成写入后才返回给客户端写入成功。</p><p>异步复制：主节点写入后向从节点发送消息，不用等待从节点写入完成确认。</p><p>半同步模式：数据库实践中，开启同步复制一般只会开启一个从节点同步，其他节点则是异步模式。当同步从节点不可用或性能下降，将其他从节点中的一个提升为同步模式。</p><h4 id=配置新的从节点>配置新的从节点
<a class=header-anchor href=#%e9%85%8d%e7%bd%ae%e6%96%b0%e7%9a%84%e4%bb%8e%e8%8a%82%e7%82%b9></a></h4><ol><li><p>在某个时间点对主节点产生一个一致性快照，避免同步主节点时锁定整个数据库。</p></li><li><p>将快照拷贝到新的从节点。</p></li><li><p>从节点连接主节点，并从快照节点开始追赶主节点。</p></li></ol><h4 id=处理失效节点>处理失效节点
<a class=header-anchor href=#%e5%a4%84%e7%90%86%e5%a4%b1%e6%95%88%e8%8a%82%e7%82%b9></a></h4><ul><li><p>从节点失效：从节点恢复后，会从崩溃时的节点继续追赶主节点。</p></li><li><p>主节点失效：可以通过手动或自动的将从节点提升为主节点，之后的写的请求会发送给主节点。</p></li></ul><p>自动切换步骤：</p><ol><li><p>确认主节点失效。节点间使用心跳机制来检测主节点是否失效，一段时间内（如30s）如果没有响应，则认为该节点失效。</p></li><li><p>选举新的主节点。通过选举的方式来选举指定新的主节点，候选节点最好与原生节点的数据量差异最小，可以最小化数据丢失的风险。</p></li><li><p>重新配置系统使新主节点生效。客户端需要将写请求更改为发送到新的主节点。如果原主节点上线，系统要保证原主节点降级为从节点并认可新的主节点。</p></li></ol><h4 id=复制日志的实现>复制日志的实现
<a class=header-anchor href=#%e5%a4%8d%e5%88%b6%e6%97%a5%e5%bf%97%e7%9a%84%e5%ae%9e%e7%8e%b0></a></h4><ul><li>基于语句复制</li></ul><p>主节点将记录所执行的每个操作请求，将操作语句作为日志发送给从节点。基于语句复制会有一些不适用场景：</p><ol><li><p>任何调用非确定性函数的语句，如Now()、Random()等，在不同的副本可能会产生不同的值。</p></li><li><p>自增列。</p></li><li><p>有副作用的语句（如触发器、存储过程、用户定义的函数等）。</p></li></ol><ul><li>基于预写日志（WAL）传输</li></ul><ol><li><p>日志结构存储引擎，日志段在后台压缩并支持垃圾回收。</p></li><li><p>对采用覆盖写磁盘的Btree结构，每次修改会预先写入日志，如系统发生崩溃，会迅速恢复到此前一致状态。</p></li></ol><ul><li>基于行的逻辑日志复制</li></ul><ol><li><p>对于行插入，日志包含所有相关列的新值。</p></li><li><p>对于行删除，日志里有唯一标识已删除的行，通常靠主键。</p></li><li><p>对于行更新，唯一标识和要更新的所有列新值。</p></li></ol><p>逻辑日志与存储引擎解耦，可以更容易的向后兼容。还可以更具逻辑语句构建自定义索引和缓存。</p><ul><li>基于触发器的复制</li></ul><h3 id=数据滞后问题>数据滞后问题
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e6%bb%9e%e5%90%8e%e9%97%ae%e9%a2%98></a></h3><p>主节点写入之后，返回成功给客户端，客户端同时查询主节点和从节点得出不一致的数据，等一段时间后从节点同步完成，主从节点最终数据一致，这叫做<strong>最终一致性</strong>。</p><h4 id=读自己写>读自己写
<a class=header-anchor href=#%e8%af%bb%e8%87%aa%e5%b7%b1%e5%86%99></a></h4><p>数据还没同步到子节点就查询的问题。</p><ul><li><p>访问可能随时会被修改的内容从主节点读。</p></li><li><p>跟踪最近的修改时间，如果不超过一分钟则读主节点。</p></li><li><p>客户端记住最近的更新时间戳，当时间戳不够新访问从节点。</p></li><li><p>如果副本在多数据中心，必须把请求路由到主节点所在的数据中心。</p></li></ul><h4 id=单调读>单调读
<a class=header-anchor href=#%e5%8d%95%e8%b0%83%e8%af%bb></a></h4><p>解决先请求后返回，后返回的数据是旧值的问题。可以确保每个用户从固定的一个副本执行读取。（如基于用户id哈希的方式）</p><h4 id=前缀一致读>前缀一致读
<a class=header-anchor href=#%e5%89%8d%e7%bc%80%e4%b8%80%e8%87%b4%e8%af%bb></a></h4><p>当两个语句有先后关系，自节点先同步了后置关系的数据。</p><p>对于一系列按照某个顺序发生的写请求，读取内容时也会按照顺序读。</p><h3 id=多主节点复制>多主节点复制
<a class=header-anchor href=#%e5%a4%9a%e4%b8%bb%e8%8a%82%e7%82%b9%e5%a4%8d%e5%88%b6></a></h3><h4 id=适用场景>适用场景
<a class=header-anchor href=#%e9%80%82%e7%94%a8%e5%9c%ba%e6%99%af></a></h4><ul><li><strong>多数据中心</strong></li></ul><ol><li><p>性能</p></li><li><p>容忍数据中心失效</p></li><li><p>容忍网络问题</p></li></ol><ul><li><strong>离线客户端操作</strong>：协作编辑。</li></ul><h4 id=处理写冲突>处理写冲突
<a class=header-anchor href=#%e5%a4%84%e7%90%86%e5%86%99%e5%86%b2%e7%aa%81></a></h4><ul><li><p>同步与异步冲突检测</p></li><li><p>避免冲突</p></li><li><p>收敛于一致状态</p></li><li><p>自定义冲突解决逻辑</p></li></ul><ol><li><p>给每个写入分配一个唯一id（如时间戳），取最后一个写入的数据，会造成数据丢失。</p></li><li><p>为每个副本分配一个唯一id，序号高的副本优先写入，也会导致数据丢失。</p></li><li><p>以某种方式将值合并。</p></li><li><p>利用预定义好的格式来记录和保留冲突相关的所有信息，依靠应用层逻辑解决。</p></li></ol><h4 id=自定义冲突解决逻辑>自定义冲突解决逻辑
<a class=header-anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%86%b2%e7%aa%81%e8%a7%a3%e5%86%b3%e9%80%bb%e8%be%91></a></h4><p>解决冲突最合适的方式还是在应用层，所以大多数多主节点复制模型都有工具让用户编写应用代码解决冲突。可以在<strong>写入时</strong>或<strong>读取时</strong>执行这些代码逻辑。</p><h4 id=拓扑结构>拓扑结构
<a class=header-anchor href=#%e6%8b%93%e6%89%91%e7%bb%93%e6%9e%84></a></h4><p>复制的拓扑结构描述了写请求从一个节点传播到其他节点的通信路径。最常见的是全部-至-全部每个主节点写入同步到其他主节点。</p><h3 id=无主节点复制>无主节点复制
<a class=header-anchor href=#%e6%97%a0%e4%b8%bb%e8%8a%82%e7%82%b9%e5%a4%8d%e5%88%b6></a></h3><h4 id=节点失效时写入数据库>节点失效时写入数据库
<a class=header-anchor href=#%e8%8a%82%e7%82%b9%e5%a4%b1%e6%95%88%e6%97%b6%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae%e5%ba%93></a></h4><p>r+w>n，被认为写入成功。</p><ul><li>读修复与反熵</li></ul><ol><li><p>读修复：当客户端并行读取多个副本，可以检测到过期的值。</p></li><li><p>反熵过程：一些后台进程不断查找副本之间数据的差异并修复。</p></li></ol><ul><li>读写quorum：如果w + r > n 则并发r个读请求一定含有最新值（通过版本号确认）</li></ul><h4 id=quorum一致性的局限性>Quorum一致性的局限性
<a class=header-anchor href=#quorum%e4%b8%80%e8%87%b4%e6%80%a7%e7%9a%84%e5%b1%80%e9%99%90%e6%80%a7></a></h4><ul><li><p>监控旧值</p></li><li><p>宽松的quorum与数据回传</p></li><li><p>多数据中心操作</p></li></ul><h4 id=检测并发写>检测并发写
<a class=header-anchor href=#%e6%a3%80%e6%b5%8b%e5%b9%b6%e5%8f%91%e5%86%99></a></h4><ul><li><p>最后写入者获胜</p></li><li><p>Happens-before关系和并发</p></li><li><p>合并同时写入的值</p></li><li><p>版本矢量</p></li></ul></div><footer class=post-footer><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="ricohgag - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="ricohgag - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
DDIA-Part5: 数据复制</li><li class=post-copyright-author><strong>本文作者： </strong>ricohgag</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/read_note/ddia/%E4%BA%94%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/ title="DDIA-Part5: 数据复制">/read_note/ddia/%E4%BA%94%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i>
</span><span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/read_note/ddia/%E5%85%AD%E6%95%B0%E6%8D%AE%E5%88%86%E5%8C%BA/ rel=next title="DDIA-Part6: 数据分区"><i class="fa fa-chevron-left"></i> DDIA-Part6: 数据分区</a></div><div class="post-nav-prev post-nav-item"><a href=/read_note/ddia/%E5%9B%9B%E6%95%B0%E6%8D%AE%E7%BC%96%E7%A0%81%E5%92%8C%E6%BC%94%E5%8C%96/ rel=prev title="DDIA-Part4: 数据编码和演化">DDIA-Part4: 数据编码和演化
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>ricohgag</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.123.6 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Mist</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":false,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Mist","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>